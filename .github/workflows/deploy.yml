name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

env:
  AWS_REGION: ap-southeast-2
  NODE_VERSION: '18'

jobs:
  deploy-backend:
    name: Deploy Backend API
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache backend dependencies
        uses: actions/cache@v4
        with:
          path: api/node_modules
          key: ${{ runner.os }}-backend-node-${{ hashFiles('api/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-node-

      - name: Cache npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cache-${{ hashFiles('api/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-cache-

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd api
          npm ci --omit=dev

      - name: Ensure Elastic Beanstalk application exists
        run: |
          if ! aws elasticbeanstalk describe-applications --application-names anmc-api --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating Elastic Beanstalk application..."
            aws elasticbeanstalk create-application \
              --application-name anmc-api \
              --description "ANMC Digital Backend API" \
              --region ${{ env.AWS_REGION }}
          else
            echo "Elastic Beanstalk application already exists"
          fi

      - name: Create deployment package
        run: |
          cd api
          zip -r ../deploy-backend.zip . -x "*.git*" "*.log" "*.env*" ".env"

      - name: Get timestamp
        id: timestamp
        run: echo "time=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Ensure S3 bucket exists
        run: |
          aws s3 mb s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} --region ${{ env.AWS_REGION }} 2>/dev/null || true
          # Enable ACLs for Elastic Beanstalk
          aws s3api put-bucket-ownership-controls \
            --bucket elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} \
            --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}] \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true

      - name: Upload to S3
        run: |
          aws s3 cp deploy-backend.zip s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/anmc-api/deploy-backend-${{ steps.timestamp.outputs.time }}.zip

      - name: Create new Elastic Beanstalk version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name anmc-api \
            --version-label ${{ github.sha }}-${{ steps.timestamp.outputs.time }} \
            --source-bundle S3Bucket=elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }},S3Key=anmc-api/deploy-backend-${{ steps.timestamp.outputs.time }}.zip \
            --description "Commit ${{ github.sha }}"

      - name: Check if environment exists
        id: check-env
        run: |
          ENV_STATUS=$(aws elasticbeanstalk describe-environments \
            --application-name anmc-api \
            --environment-names anmc-api-prod \
            --region ${{ env.AWS_REGION }} \
            --query "Environments[?Status!='Terminated'] | [0].Status" \
            --output text 2>/dev/null || echo "None")
          if [ "$ENV_STATUS" = "None" ] || [ -z "$ENV_STATUS" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No active environment found"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Active environment found with status: $ENV_STATUS"
          fi

      - name: Deploy to Elastic Beanstalk
        if: steps.check-env.outputs.exists == 'true'
        run: |
          # Update environment with new version and ensure CORS_ORIGINS is set
          aws elasticbeanstalk update-environment \
            --application-name anmc-api \
            --environment-name anmc-api-prod \
            --version-label ${{ github.sha }}-${{ steps.timestamp.outputs.time }} 
      - name: Create Elastic Beanstalk environment (if needed)
        if: steps.check-env.outputs.exists == 'false'
        run: |
          echo "‚ö†Ô∏è Elastic Beanstalk environment 'anmc-api-prod' does not exist!"
          echo "Please run the 'Initial AWS Setup' workflow first to create the environment."
          echo "Or manually create the environment in the AWS Console."
          exit 1

      - name: Invalidate API CloudFront cache
        if: steps.check-env.outputs.exists == 'true'
        run: |
          # Invalidate API CloudFront distribution
          API_CF_DIST_ID="ERV6IVUVM9BD1"
          echo "Invalidating API CloudFront cache (${API_CF_DIST_ID})..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${API_CF_DIST_ID} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "API CloudFront invalidation created: $INVALIDATION_ID"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Backend deployment successful!"
          else
            echo "‚ùå Backend deployment failed!"
          fi

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend # Wait for backend to deploy first

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache frontend dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-frontend-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-

      - name: Cache npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cache-frontend-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-cache-frontend-

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Build React application
        run: |
          echo "Building with API URL: ${REACT_APP_API_URL}"
          npm run build
        env:
          CI: false
          REACT_APP_API_URL: https://d140ihn2kmroxe.cloudfront.net/api
          REACT_APP_COGNITO_USER_POOL_ID: ap-southeast-2_egMmxcO1M
          REACT_APP_COGNITO_CLIENT_ID: 2h0bk9340rlmevdnsof7ml31ai
          REACT_APP_COGNITO_REGION: ap-southeast-2
          REACT_APP_STRIPE_PUBLISHABLE_KEY: pk_live_51JYhlrS6PY8ggF6RVa4ZEa2ryGonFLwxypKM2LK6PsB556GmE1LSDdQHtlUvV5FTIjCzhusCz9I0ZVZZFP7Rn24x00apKYgRV8

      - name: Deploy to S3
        run: |
          # Sync all static assets with long cache
          aws s3 sync build/ s3://${{ secrets.S3_FRONTEND_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "service-worker.js" \
            --exclude "*.map"

          # Upload index.html with no-cache (critical for SPA updates)
          aws s3 cp build/index.html s3://${{ secrets.S3_FRONTEND_BUCKET }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"

          # Upload service worker with no-cache (if exists)
          if [ -f "build/service-worker.js" ]; then
            aws s3 cp build/service-worker.js s3://${{ secrets.S3_FRONTEND_BUCKET }}/service-worker.js \
              --cache-control "no-cache, no-store, must-revalidate"
          fi

      - name: Invalidate CloudFront cache
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "Invalidating CloudFront cache..."
            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)
            echo "CloudFront invalidation created: $INVALIDATION_ID"
          else
            echo "‚ö†Ô∏è CLOUDFRONT_DISTRIBUTION_ID not set, skipping cache invalidation"
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Frontend deployment successful!"
            echo "üì± CloudFront URL: https://${{ secrets.CLOUDFRONT_DOMAIN }}"
            echo "üì± S3 Bucket: ${{ secrets.S3_FRONTEND_BUCKET }}"
          else
            echo "‚ùå Frontend deployment failed!"
          fi

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "üöÄ Deployment Complete!"
          echo "================================"
          echo "Backend Status: ${{ needs.deploy-backend.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend.result }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
