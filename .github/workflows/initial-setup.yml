name: Initial AWS Setup (Run Once)

on:
  workflow_dispatch: # Manual trigger only

env:
  AWS_REGION: ap-southeast-2
  NODE_VERSION: '18'
  EB_APP_NAME: anmc-api
  EB_ENV_NAME: anmc-api-prod
  S3_BUCKET_NAME: anmc-frontend

jobs:
  setup-elastic-beanstalk:
    name: Setup Elastic Beanstalk
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install EB CLI
        run: |
          pip install awsebcli --upgrade

      - name: Check if EB application exists
        id: check-app
        continue-on-error: true
        run: |
          APP_COUNT=$(aws elasticbeanstalk describe-applications \
            --application-names ${{ env.EB_APP_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "length(Applications)" \
            --output text 2>/dev/null || echo "0")
          if [ "$APP_COUNT" = "0" ]; then
            echo "Application does not exist"
            exit 1
          else
            echo "Application exists"
          fi

      - name: Create EB application
        if: steps.check-app.outcome == 'failure'
        run: |
          aws elasticbeanstalk create-application \
            --application-name ${{ env.EB_APP_NAME }} \
            --description "ANMC Digital Backend API" \
            --region ${{ env.AWS_REGION }}

      - name: Check if EB environment exists
        id: check-env
        continue-on-error: true
        run: |
          ENV_STATUS=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ env.EB_APP_NAME }} \
            --environment-names ${{ env.EB_ENV_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "Environments[?Status!='Terminated'] | [0].Status" \
            --output text 2>/dev/null || echo "None")
          if [ "$ENV_STATUS" = "None" ] || [ -z "$ENV_STATUS" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No active environment found"
            exit 1
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Active environment found with status: $ENV_STATUS"
          fi

      - name: Setup Node.js
        if: steps.check-env.outcome == 'failure'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create initial deployment package
        if: steps.check-env.outcome == 'failure'
        run: |
          cd api
          npm ci --omit=dev
          zip -r ../deploy-backend-initial.zip . -x "*.git*" "*.log" "*.env*" ".env"

      - name: Upload initial package to S3
        if: steps.check-env.outcome == 'failure'
        run: |
          aws s3 mb s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} --region ${{ env.AWS_REGION }} || true
          # Enable ACLs for Elastic Beanstalk
          aws s3api put-bucket-ownership-controls \
            --bucket elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} \
            --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}] \
            --region ${{ env.AWS_REGION }} || true
          aws s3 cp deploy-backend-initial.zip s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/anmc-api/

      - name: Create initial application version
        if: steps.check-env.outcome == 'failure'
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APP_NAME }} \
            --version-label initial-${{ github.sha }} \
            --source-bundle S3Bucket=elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }},S3Key=anmc-api/deploy-backend-initial.zip \
            --description "Initial deployment"

      - name: Create EB environment
        if: steps.check-env.outcome == 'failure'
        run: |
          aws elasticbeanstalk create-environment \
            --application-name ${{ env.EB_APP_NAME }} \
            --environment-name ${{ env.EB_ENV_NAME }} \
            --solution-stack-name "64bit Amazon Linux 2023 v6.6.8 running Node.js 20" \
            --option-settings \
              Namespace=aws:autoscaling:launchconfiguration,OptionName=InstanceType,Value=t3.small \
              Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role \
              Namespace=aws:elasticbeanstalk:environment,OptionName=EnvironmentType,Value=SingleInstance \
              Namespace=aws:elasticbeanstalk:environment,OptionName=ServiceRole,Value=aws-elasticbeanstalk-service-role \
              Namespace=aws:elasticbeanstalk:application:environment,OptionName=NODE_ENV,Value=production \
              Namespace=aws:elasticbeanstalk:application:environment,OptionName=AWS_REGION,Value=${{ env.AWS_REGION }} \
              Namespace=aws:elasticbeanstalk:application:environment,OptionName=PORT,Value=8080 \
              Namespace=aws:elasticbeanstalk:application:environment,OptionName=CORS_ORIGIN,Value=http://${{ env.S3_FRONTEND_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com \
            --version-label initial-${{ github.sha }}

      - name: Wait for environment creation
        if: steps.check-env.outcome == 'failure'
        run: |
          echo "Waiting for environment to be ready (this may take 5-10 minutes)..."
          aws elasticbeanstalk wait environment-exists \
            --application-name ${{ env.EB_APP_NAME }} \
            --environment-names ${{ env.EB_ENV_NAME }}

      - name: Get EB environment URL
        if: always()
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ env.EB_APP_NAME }} \
            --environment-names ${{ env.EB_ENV_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "Environments[0].CNAME" \
            --output text 2>/dev/null || echo "None")
          if [ "$URL" != "None" ] && [ "$URL" != "" ]; then
            echo "ðŸŒ Backend API URL: https://$URL"
            echo "âš ï¸  Update GitHub Secret REACT_APP_API_URL to: https://$URL/api"
          else
            echo "âš ï¸ No environment found. Environment creation may have failed."
          fi

  setup-frontend-bucket:
    name: Setup S3 Frontend Bucket
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if S3 bucket exists
        id: check-bucket
        continue-on-error: true
        run: |
          aws s3 ls s3://${{ env.S3_BUCKET_NAME }}

      - name: Create S3 bucket
        if: steps.check-bucket.outcome == 'failure'
        run: |
          aws s3 mb s3://${{ env.S3_BUCKET_NAME }} --region ${{ env.AWS_REGION }}

      - name: Enable static website hosting
        run: |
          aws s3 website s3://${{ env.S3_BUCKET_NAME }} \
            --index-document index.html \
            --error-document index.html

      - name: Disable Block Public Access for bucket
        continue-on-error: true
        run: |
          echo "Attempting to disable Block Public Access..."
          aws s3api put-public-access-block \
            --bucket ${{ env.S3_BUCKET_NAME }} \
            --public-access-block-configuration \
              "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

      - name: Set bucket policy
        continue-on-error: true
        run: |
          cat > bucket-policy.json << 'EOF'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::${{ env.S3_BUCKET_NAME }}/*"
              }
            ]
          }
          EOF
          echo "Setting bucket policy..."
          if ! aws s3api put-bucket-policy \
            --bucket ${{ env.S3_BUCKET_NAME }} \
            --policy file://bucket-policy.json; then
            echo "âš ï¸ Failed to set public bucket policy."
            echo "âš ï¸ S3 Block Public Access is enabled on your account."
            echo "âš ï¸ You have two options:"
            echo "   1. Manually disable Block Public Access in AWS Console"
            echo "   2. Use CloudFront distribution for better security"
            echo "âš ï¸ For now, bucket is private. You'll need to set up CloudFront or disable Block Public Access manually."
          fi

      - name: Enable CORS
        run: |
          cat > cors.json << 'EOF'
          {
            "CORSRules": [
              {
                "AllowedOrigins": ["*"],
                "AllowedHeaders": ["*"],
                "AllowedMethods": ["GET", "HEAD"],
                "MaxAgeSeconds": 3000
              }
            ]
          }
          EOF
          aws s3api put-bucket-cors \
            --bucket ${{ env.S3_BUCKET_NAME }} \
            --cors-configuration file://cors.json

      - name: Get frontend URL
        run: |
          echo "ðŸŒ Frontend URL: http://${{ env.S3_BUCKET_NAME }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
          echo "âš ï¸  Update GitHub Secret S3_FRONTEND_BUCKET to: ${{ env.S3_BUCKET_NAME }}"

  summary:
    name: Setup Summary
    runs-on: ubuntu-latest
    needs: [setup-elastic-beanstalk, setup-frontend-bucket]
    if: always()

    steps:
      - name: Print setup summary
        run: |
          echo "âœ… Initial AWS Setup Complete!"
          echo "================================"
          echo ""
          echo "ðŸ“‹ Next Steps:"
          echo "1. Get the Backend API URL from the logs above"
          echo "2. Update GitHub Secret: REACT_APP_API_URL"
          echo "3. Update GitHub Secret: S3_FRONTEND_BUCKET"
          echo "4. Run the main 'Deploy to AWS' workflow"
          echo ""
          echo "ðŸ”§ Required GitHub Secrets:"
          echo "- AWS_ACCESS_KEY_ID"
          echo "- AWS_SECRET_ACCESS_KEY"
          echo "- AWS_ACCOUNT_ID"
          echo "- REACT_APP_API_URL (from EB output)"
          echo "- REACT_APP_COGNITO_USER_POOL_ID"
          echo "- REACT_APP_COGNITO_CLIENT_ID"
          echo "- REACT_APP_STRIPE_PUBLISHABLE_KEY"
          echo "- S3_FRONTEND_BUCKET"
          echo "- CLOUDFRONT_DISTRIBUTION_ID (optional)"
